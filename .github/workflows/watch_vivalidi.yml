name: Vivaldi Blog Update Watcher

on:
  schedule:
    - cron: "0 23 * * *"   # ÊØéÊó• Êúù8ÊôÇÔºàJSTÔºâ
  workflow_dispatch:

jobs:
  watch:
    runs-on: ubuntu-latest
    steps:
      - name: Restore previous schedule cache
        uses: actions/cache@v4
        with:
          path: prev
          key: schedule-prev

      - name: Fetch latest blog page
        run: |
          curl -s https://vivaldi.com/ja/blog/latest/ > full.html
      
      - name: Extract blogcard URLs
        run: |
          sed -n '/<div class="column w50 w100-mobile">/,/<\/div><\/div><\/div>/p' full.html \
            | grep -oE 'https://vivaldi\.com/ja/blog/[^"]+' \
            | sort -u \
            > current_urls.txt

      - name: Compare with previous
        id: diff
        run: |
          changed=false
          mkdir -p prev
          if [ -f prev/urls.txt ]; then
            diff prev/urls.txt current_urls.txt > /dev/null || changed=true
          else
            changed=true
          fi
          # Ê¨°ÂõûÊØîËºÉÁî®„Å´ current_urls.txt „Çí prev/urls.txt „Å´„Ç≥„Éî„Éº
          cp current_urls.txt prev/urls.txt
          echo "changed=$changed" >> $GITHUB_OUTPUT

      - name: Notify Discord
        if: steps.diff.outputs.changed == 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_USER_ID: ${{ secrets.DISCORD_USER_ID }}
        run: |
          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"content\": \"<@${DISCORD_USER_ID}> üîîVivaldi„Éñ„É≠„Ç∞ÔºàÊúÄÊñ∞Ë®ò‰∫ãÔºâ„ÅåÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü\nhttps://vivaldi.com/ja/blog/latest/\", \"allowed_mentions\": {\"users\": [\"${DISCORD_USER_ID}\"]}}"

      - name: Save schedule cache
        if: always()
        uses: actions/cache@v4
        with:
          path: prev
          key: schedule-prev
          