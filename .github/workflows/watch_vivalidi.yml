name: Vivaldi Blog Update Watcher

on:
  schedule:
    - cron: "0 23 * * *"   # ÊØéÊó• Êúù8ÊôÇÔºàJSTÔºâ
  workflow_dispatch:

jobs:
  watch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set date keys
        run: |
          echo "TODAY=$(date -u +'%Y-%m-%d')" >> $GITHUB_ENV
          echo "YESTERDAY=$(date -u -d '1 day ago' +'%Y-%m-%d')" >> $GITHUB_ENV
          echo "CUTOFF_DATE=$(date -u -d '10 days ago' +'%Y-%m-%d')" >> $GITHUB_ENV
      
      - name: Restore previous schedule cache
        uses: actions/cache@v4
        with:
          path: prev
          key: schedule-prev-${{ env.YESTERDAY }}
          restore-keys: |
            schedule-prev-
          fail-on-cache-miss: false

      - name: Run watcher script
        id: diff
        run: |
          chmod +x scripts/watch_vivaldi.sh
          ./scripts/watch_vivaldi.sh

      - name: Notify Discord
        if: steps.diff.outputs.changed == 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_USER_ID: ${{ secrets.DISCORD_USER_ID }}
        run: |
          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"content\": \"<@${DISCORD_USER_ID}> üîîVivaldi„Éñ„É≠„Ç∞ÔºàÊúÄÊñ∞Ë®ò‰∫ãÔºâ„ÅåÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü\nhttps://vivaldi.com/ja/blog/latest/\", \"allowed_mentions\": {\"users\": [\"${DISCORD_USER_ID}\"]}}"

      - name: Save schedule cache
        if: always()
        uses: actions/cache@v4
        with:
          path: prev
          key: schedule-prev-${{ env.TODAY }}

      - name: Delete old caches
        if: always()
        run: |
          gh cache list --limit 100 | grep 'schedule-prev-' | while read -r line; do
            CACHE_ID=$(echo "$line" | awk '{print $1}')
            CACHE_KEY=$(echo "$line" | awk '{print $2}')
            CACHE_DATE=$(echo "$CACHE_KEY" | sed 's/schedule-prev-//')
            if [[ "$CACHE_DATE" < "${{ env.CUTOFF_DATE }}" ]]; then
              gh cache delete "$CACHE_ID"
            fi
          done
        env:
          GH_TOKEN: ${{ github.token }}
          